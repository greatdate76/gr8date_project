{% comment %} expects: target_username, target_display {% endcomment %}
<button id="gd-quickmsg-btn"
        type="button"
        style="border:0;background:transparent;cursor:pointer"
        title="Message {{ target_display }}">
  ✉️
</button>

<!-- lightweight modal -->
<div id="gd-quickmsg-modal"
     style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:12px;max-width:480px;width:92%;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
      <strong>Message {{ target_display }}</strong>
      <button type="button" id="gd-quickmsg-close" style="border:0;background:transparent;font-size:18px;cursor:pointer">×</button>
    </div>
    <textarea id="gd-quickmsg-body"
              rows="4"
              style="width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px"
              placeholder="Type your message…"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button type="button" id="gd-quickmsg-cancel" style="padding:8px 12px;border:1px solid #e5e7eb;background:#fff;border-radius:8px;cursor:pointer">Cancel</button>
      <button type="button" id="gd-quickmsg-send" style="padding:8px 14px;border:0;background:#111827;color:#fff;border-radius:8px;cursor:pointer">
        Send
      </button>
    </div>
    <div id="gd-quickmsg-status" style="margin-top:8px;font-size:13px;color:#065f46;display:none"></div>
  </div>
</div>

<script>
(function(){
  const btn = document.getElementById('gd-quickmsg-btn');
  const modal = document.getElementById('gd-quickmsg-modal');
  const body = document.getElementById('gd-quickmsg-body');
  const send = document.getElementById('gd-quickmsg-send');
  const close = document.getElementById('gd-quickmsg-close');
  const cancel = document.getElementById('gd-quickmsg-cancel');
  const status = document.getElementById('gd-quickmsg-status');
  const targetUsername = "{{ target_username|escapejs }}";
  const threadUrlTpl = "{% url 'pages:api_thread_messages' username='__U__' %}";

  function show(){ modal.style.display='flex'; body.focus(); }
  function hide(){ modal.style.display='none'; status.style.display='none'; body.value=''; }
  function getCookie(name){
    const v = (`; ${document.cookie}`).split(`; ${name}=`); if (v.length === 2) return v.pop().split(';').shift();
  }

  btn?.addEventListener('click', (e)=>{ e.preventDefault(); show(); });
  close?.addEventListener('click', hide);
  cancel?.addEventListener('click', hide);
  modal?.addEventListener('click', (e)=>{ if(e.target===modal) hide(); });

  async function sendMsg(){
    const text = body.value.trim();
    if(!text) return;
    send.disabled = true;
    try{
      const resp = await fetch(threadUrlTpl.replace('__U__', encodeURIComponent(targetUsername)), {
        method:'POST',
        credentials:'same-origin',
        headers:{
          'Content-Type':'application/json',
          'X-Requested-With':'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken') || ''
        },
        body: JSON.stringify({body: text})
      });
      if(!resp.ok){ throw new Error(await resp.text()); }
      status.textContent = "Message sent!";
      status.style.display = 'block';
      if (window.gdRefreshBadges) { gdRefreshBadges(); }
      setTimeout(hide, 700);
    }catch(err){
      status.textContent = "Could not send message. Please try again.";
      status.style.color = '#991b1b';
      status.style.display = 'block';
    }finally{
      send.disabled = false;
    }
  }

  send?.addEventListener('click', sendMsg);
  body?.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && (e.metaKey || e.ctrlKey)) sendMsg(); });
})();
</script>

