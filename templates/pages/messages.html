{% extends "base.html" %}
{% block content %}
<style>
.gd-wrap{display:grid;grid-template-columns:280px 1fr;gap:16px;min-height:65vh}
.gd-card{border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;background:#fff}
.gd-head{padding:10px 12px;border-bottom:1px solid #e5e7eb;font-weight:600}
.gd-list{max-height:70vh;overflow:auto;background:#fafafa}
.gd-thread{display:flex;justify-content:space-between;gap:8px;padding:10px 12px;border-bottom:1px solid #f1f5f9;cursor:pointer}
.gd-thread:hover{background:#f8fafc}
.gd-unread{background:#fee2e2}
.gd-msgs{display:flex;flex-direction:column;gap:8px;padding:12px;max-height:60vh;overflow:auto}
.gd-bubble{max-width:70%;padding:8px 12px;border-radius:12px;line-height:1.35}
.gd-bubble.me{align-self:flex-end;background:#dcfce7}
.gd-bubble.them{align-self:flex-start;background:#eef2ff}
.gd-send{display:flex;gap:8px;padding:10px;border-top:1px solid #e5e7eb;background:#fff}
.gd-send input{flex:1;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
.gd-send button{padding:10px 14px;border:0;border-radius:8px;background:#111827;color:#fff}
</style>

<div class="gd-wrap">
  <div class="gd-card">
    <div class="gd-head">Conversations</div>
    <div id="threads" class="gd-list"></div>
  </div>

  <div class="gd-card">
    <div class="gd-head">
      <span id="chat-title">Select a conversation</span>
    </div>
    <div id="messages" class="gd-msgs"></div>
    <div class="gd-send">
      <input id="msg-input" type="text" placeholder="Type a messageâ€¦" />
      <button id="msg-send" type="button">Send</button>
    </div>
  </div>
</div>

<script>
const threadsEl = document.getElementById('threads');
const messagesEl = document.getElementById('messages');
const titleEl = document.getElementById('chat-title');
const inputEl = document.getElementById('msg-input');
const sendBtn = document.getElementById('msg-send');
let currentUser = null;

async function fetchJSON(url, opts={}) {
  const resp = await fetch(url, {
    credentials:'same-origin',
    headers:{'X-Requested-With':'XMLHttpRequest','Content-Type':'application/json'},
    ...opts
  });
  if (!resp.ok) { throw new Error(await resp.text()); }
  return resp.json();
}

async function loadThreads() {
  const rows = await fetchJSON("{% url 'pages:api_threads' %}");
  threadsEl.innerHTML = '';
  rows.forEach(r => {
    const div = document.createElement('div');
    div.className = 'gd-thread' + (r.unread_count ? ' gd-unread' : '');
    div.dataset.username = r.other_username;
    div.innerHTML = `
      <div><strong>${r.other_display}</strong><br><small>${r.last_message || ''}</small></div>
      <div>${r.unread_count ? `<span class="badge">${r.unread_count}</span>` : ''}</div>`;
    div.addEventListener('click', () => openThread(r.other_username, r.other_display));
    threadsEl.appendChild(div);
  });
}

async function openThread(username, display) {
  currentUser = username;
  titleEl.textContent = display;
  const msgs = await fetchJSON("{% url 'pages:api_thread_messages' username='__u__' %}".replace('__u__', encodeURIComponent(username)));
  messagesEl.innerHTML = '';
  msgs.forEach(m => addBubble(m));
  messagesEl.scrollTop = messagesEl.scrollHeight;
  if (window.gdRefreshBadges) { gdRefreshBadges(); }
}

function addBubble(m) {
  const div = document.createElement('div');
  const me = "{{ request.user.username|escapejs }}";
  div.className = 'gd-bubble ' + (m.sender_username === me ? 'me' : 'them');
  div.textContent = m.body;
  messagesEl.appendChild(div);
}

async function sendMessage() {
  if (!currentUser) return;
  const body = inputEl.value.trim();
  if (!body) return;
  const m = await fetchJSON(
    "{% url 'pages:api_thread_messages' username='__u__' %}".replace('__u__', encodeURIComponent(currentUser)),
    {method:'POST', body: JSON.stringify({body})}
  );
  addBubble(m);
  inputEl.value = '';
  messagesEl.scrollTop = messagesEl.scrollHeight;
  if (window.gdRefreshBadges) { gdRefreshBadges(); }
}

sendBtn.addEventListener('click', sendMessage);
inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendMessage(); });

loadThreads().catch(console.error);
</script>
{% endblock %}

